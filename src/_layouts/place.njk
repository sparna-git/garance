---js
{
  layout: "main.njk",
  pagination: {
      data: "places.graph",
      size: 1,
      alias: "thePlace",
      before: function(paginationData, fullData) {

        // filter out entries without an id
        let items = paginationData.filter(item => item.id);

        // Merge in any top-level properties from fullData.placesLocation.graph
        // matching by id. Do NOT overwrite existing properties on the
        // pagination item — only add properties that are missing.
        if (fullData && fullData.placesLocation && Array.isArray(fullData.placesLocation.graph)) {
          const locById = fullData.placesLocation.graph.reduce((acc, obj) => {
            if (obj && obj.id) acc[obj.id] = obj;
            return acc;
          }, {});

          items = items.map(item => {
            const loc = locById[item.id];
            if (loc) {
              for (const [k, v] of Object.entries(loc)) {
                if (!(k in item)) {
                  item[k] = v;
                }
              }
            }
            return item;
          });
        }

        return items;
      }
  },
  permalink: "entities/place/{{ thePlace.id | localName }}/"
}
---

{# "with context" means the imported templates will have access to all data #}
{# see https://mozilla.github.io/nunjucks/templating.html#import #}
{% import "src/_layouts/jsonld.njk" as jsonld with context %}
{% import "src/_layouts/agentorPlaceHeader.njk" as header with context %}


{# disable pagefind image #}
<span data-pagefind-meta="image:" />

{% set headerData = placesHeader | findById(thePlace.id) %}
{{ header.header(headerData) }}

{# first parameter is the object to print, second parameter is the main entity printed #}
{{ jsonld.render(thePlace,headerData) }}



<!-- Leaflet -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<!-- Terraformer WKT Parser -->
<script src="https://unpkg.com/@terraformer/wkt"></script>

<script>
  let collectsData = document.querySelectorAll("div #map")
  // Get the Element
  for(let mapId of collectsData) {
    // Get attribute data
    let dataValue = mapId.getAttribute("data");
    // Your WKT MULTIPOLYGON string
    let wkt = dataValue 
    // Parse WKT → GeoJSON
    let geojson = Terraformer.wktToGeoJSON(wkt);
    // Initialize Leaflet map
    let map = L.map(mapId).setView([0, 0], 2);
      
    // Add OSM basemap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Leaflet expects [lat, lng], but GeoJSON gives [lng, lat]
    let layer = L.geoJSON(geojson, {
      coordsToLatLng: function (coords) {
        return L.latLng(coords[1], coords[0]);
      },
      style: { color: 'red', weight: 2 }
    }).addTo(map);

    // Zoom to polygon
    map.fitBounds(layer.getBounds());
  
  }  
</script>